{% extends "adminView/base.html" %}
{% block content %}

<div class="container-fluid px-4 py-5 bg-light">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">

      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#" class="text-decoration-none text-muted">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="#" class="text-decoration-none text-muted">Vehicles</a></li>
          <li class="breadcrumb-item active text-primary" aria-current="page">Add New</li>
        </ol>
      </nav>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm border-0 rounded-3 mb-4" role="alert">
            <div class="d-flex align-items-center">
              {% if message.tags == 'success' %}
                <i class="bi bi-check-circle-fill fs-4 me-3 text-success"></i>
              {% else %}
                <i class="bi bi-exclamation-triangle-fill fs-4 me-3 text-warning"></i>
              {% endif %}
              <div>{{ message }}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        
        <div class="card-header border-0 py-4 position-relative overflow-hidden" style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);">
          <div class="position-absolute top-0 end-0 p-3 opacity-10">
            <i class="bi bi-car-front-fill" style="font-size: 10rem; color: white;"></i>
          </div>
          
          <div class="d-flex align-items-center justify-content-between position-relative z-1">
            <div class="text-white">
              <h3 class="mb-1 fw-bold">Add New Vehicle</h3>
              <p class="mb-0 opacity-75">Enter the vehicle details to add it to the fleet.</p>
            </div>
            <a href="{% url 'adminpanel:admin-dashboard' %}" class="btn btn-light btn-sm rounded-pill shadow-sm px-3 fw-semibold text-primary">
              <i class="bi bi-arrow-left me-1"></i> Back to List
            </a>
          </div>
        </div>

        <div class="card-body p-4 p-md-5">

          <form method="post" enctype="multipart/form-data" novalidate id="vehicleForm">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger rounded-3 mb-4">
                <i class="bi bi-exclamation-circle me-2"></i> {{ form.non_field_errors }}
              </div>
            {% endif %}

            <section class="mb-5">
              <h6 class="text-uppercase text-muted fw-bold mb-4 ls-1">
                <i class="bi bi-card-text me-2"></i>Basic Details
              </h6>
              
              <div class="row g-4">
                <div class="col-md-8">
                  <div class="form-floating">
                    <input type="text" 
                           name="{{ form.name.name }}" 
                           id="{{ form.name.auto_id }}"
                           class="form-control {% if form.name.errors %}is-invalid{% endif %}"
                           value="{{ form.name.value|default:'' }}"
                           placeholder="Vehicle Name"
                           required>
                    <label for="{{ form.name.auto_id }}">{{ form.name.label }} <span class="text-danger">*</span></label>
                    {% if form.name.errors %}
                      <div class="invalid-feedback">{{ form.name.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="form-floating">
                    <input type="text" 
                           name="{{ form.vehicle_no.name }}"
                           id="{{ form.vehicle_no.auto_id }}" 
                           class="form-control text-uppercase {% if form.vehicle_no.errors %}is-invalid{% endif %}"
                           value="{{ form.vehicle_no.value|default:'' }}"
                           placeholder="KL-01-AB-1234"
                           required>
                    <label for="{{ form.vehicle_no.auto_id }}">{{ form.vehicle_no.label }}</label>
                    {% if form.vehicle_no.errors %}
                      <div class="invalid-feedback">{{ form.vehicle_no.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-semibold small text-muted">{{ form.type.label }}</label>
                  <select name="{{ form.type.name }}" 
                          id="{{ form.type.auto_id }}"
                          class="form-select form-select-lg {% if form.type.errors %}is-invalid{% endif %}"
                          required>
                    <option value="">Select Type</option>
                    {% for value, label in form.type.field.choices %}
                      <option value="{{ value }}" {% if form.type.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  {% if form.type.errors %}<div class="invalid-feedback">{{ form.type.errors.0 }}</div>{% endif %}
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-semibold small text-muted">{{ form.price.label }}</label>
                  <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white text-muted border-end-0"><i class="bi bi-currency-rupee"></i></span>
                    <input type="number" 
                           name="{{ form.price.name }}" 
                           id="{{ form.price.auto_id }}"
                           class="form-control border-start-0 ps-0 {% if form.price.errors %}is-invalid{% endif %}"
                           value="{{ form.price.value|default:'' }}"
                           placeholder="0.00"
                           min="0" required>
                    <span class="input-group-text bg-light text-muted fs-6">/ day</span>
                    {% if form.price.errors %}<div class="invalid-feedback">{{ form.price.errors.0 }}</div>{% endif %}
                  </div>
                </div>

                <div class="col-md-4">
                   <label class="form-label fw-semibold small text-muted">{{ form.seats.label }}</label>
                   <div class="input-group input-group-lg">
                    <input type="number" 
                           name="{{ form.seats.name }}" 
                           id="{{ form.seats.auto_id }}"
                           class="form-control {% if form.seats.errors %}is-invalid{% endif %}"
                           value="{{ form.seats.value|default:'' }}"
                           placeholder="4"
                           min="1" required>
                    <span class="input-group-text bg-white text-muted"><i class="bi bi-person-fill"></i></span>
                    {% if form.seats.errors %}<div class="invalid-feedback">{{ form.seats.errors.0 }}</div>{% endif %}
                   </div>
                </div>
              </div>
            </section>

            <hr class="my-5 border-secondary opacity-10">

            <section class="mb-5">
              <h6 class="text-uppercase text-muted fw-bold mb-4 ls-1">
                <i class="bi bi-gear-wide-connected me-2"></i>Specifications
              </h6>

              <div class="row g-4 align-items-end">
                <div class="col-md-4">
                  <label class="form-label fw-semibold small text-muted">{{ form.fuel_type.label }}</label>
                  <select name="{{ form.fuel_type.name }}" id="{{ form.fuel_type.auto_id }}" class="form-select form-select-lg {% if form.fuel_type.errors %}is-invalid{% endif %}">
                    <option value="">Select Fuel</option>
                    {% for value, label in form.fuel_type.field.choices %}
                      <option value="{{ value }}" {% if form.fuel_type.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  {% if form.fuel_type.errors %}<div class="invalid-feedback">{{ form.fuel_type.errors.0 }}</div>{% endif %}
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-semibold small text-muted">{{ form.transmission.label }}</label>
                  <select name="{{ form.transmission.name }}" id="{{ form.transmission.auto_id }}" class="form-select form-select-lg {% if form.transmission.errors %}is-invalid{% endif %}">
                    <option value="">Select Transmission</option>
                    {% for value, label in form.transmission.field.choices %}
                      <option value="{{ value }}" {% if form.transmission.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  {% if form.transmission.errors %}<div class="invalid-feedback">{{ form.transmission.errors.0 }}</div>{% endif %}
                </div>

                <div class="col-md-4">
                  <div class="bg-light p-3 rounded-3 d-flex align-items-center justify-content-between border">
                    <div>
                      <label class="form-check-label fw-bold text-dark" for="{{ form.available.auto_id }}">Availability</label>
                      <div class="small text-muted">Is this car ready to rent?</div>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" role="switch" 
                             name="{{ form.available.name }}" 
                             id="{{ form.available.auto_id }}"
                             {% if form.available.value %}checked{% endif %} 
                             style="width: 3.5rem; height: 1.75rem;">
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <hr class="my-5 border-secondary opacity-10">

            <section class="mb-5">
              <h6 class="text-uppercase text-muted fw-bold mb-4 ls-1">
                <i class="bi bi-images me-2"></i>Gallery
              </h6>
              
              <div class="row g-4">
                {% for field in form %}
                  {% if 'image' in field.name %}
                  <div class="col-md-4 col-sm-6">
                    <label class="form-label fw-semibold small text-muted">{{ field.label }}</label>
                    
                    <div class="image-upload-wrapper {% if field.errors %}border-danger{% endif %}">
                      <input type="file" 
                             name="{{ field.name }}" 
                             id="{{ field.auto_id }}"
                             class="d-none image-input" 
                             accept="image/*"
                             {% if forloop.first %}required{% endif %}
                             onchange="handleImagePreview(this)">
                      
                      <label for="{{ field.auto_id }}" class="upload-label">
                        <div class="upload-placeholder text-center p-4">
                          <div class="icon-circle mb-3 bg-light text-primary mx-auto">
                            <i class="bi bi-cloud-arrow-up-fill fs-4"></i>
                          </div>
                          <span class="d-block fw-semibold text-dark">Click to Upload</span>
                          <span class="d-block small text-muted">JPG, PNG (Max 5MB)</span>
                        </div>
                        
                        <div class="preview-container d-none text-center">
                          <img src="" class="img-preview img-fluid rounded-3 mb-2">
                          <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-btn" onclick="removeImage(this, '{{ field.auto_id }}')">
                            <i class="bi bi-trash me-1"></i> Remove
                          </button>
                        </div>
                      </label>
                    </div>
                    {% if field.errors %}
                      <div class="text-danger small mt-1">{{ field.errors.0 }}</div>
                    {% endif %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
            </section>

            <div class="d-flex flex-column flex-md-row gap-3 pt-3">
              <button type="submit" class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm">
                <i class="bi bi-check-lg me-2"></i> Save Vehicle
              </button>
              <button type="reset" class="btn btn-light btn-lg px-4 rounded-pill border" onclick="resetPreviews()">
                Reset
              </button>
              <a href="#" class="btn btn-outline-secondary btn-lg px-4 rounded-pill ms-md-auto">
                Cancel
              </a>
            </div>

          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Custom Styling */
.ls-1 { letter-spacing: 1px; }

.form-control-lg, .form-select-lg {
  font-size: 1rem;
  padding: 0.75rem 1rem;
}

.form-control:focus, .form-select:focus {
  border-color: #818cf8;
  box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.15);
}

/* Image Upload Styling */
.image-upload-wrapper {
  border: 2px dashed #cbd5e1;
  border-radius: 1rem;
  background: #f8fafc;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  height: 250px; /* Fixed height for consistency */
}

.image-upload-wrapper:hover {
  border-color: #818cf8;
  background: #fff;
}

.upload-label {
  width: 100%;
  height: 100%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.icon-circle {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}

.upload-label:hover .icon-circle {
  transform: scale(1.1);
  background-color: #e0e7ff !important;
}

.preview-container {
  width: 100%;
  height: 100%;
  padding: 0.5rem;
  display: flex;
  flex-direction: column;
}

.img-preview {
  width: 100%;
  height: 85%; /* Leave room for delete button */
  object-fit: cover;
}
</style>

<script>
// Handle Image Preview
function handleImagePreview(input) {
  const wrapper = input.closest('.image-upload-wrapper');
  const placeholder = wrapper.querySelector('.upload-placeholder');
  const previewContainer = wrapper.querySelector('.preview-container');
  const previewImage = wrapper.querySelector('.img-preview');

  if (input.files && input.files[0]) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      previewImage.src = e.target.result;
      placeholder.classList.add('d-none');
      previewContainer.classList.remove('d-none');
      wrapper.style.borderStyle = 'solid'; // Change dashed to solid on fill
    }
    
    reader.readAsDataURL(input.files[0]);
  }
}

// Remove Image and Reset Field
function removeImage(btn, inputId) {
  event.preventDefault(); // Prevent opening the file dialog
  const input = document.getElementById(inputId);
  input.value = ''; // Clear file input
  
  const wrapper = btn.closest('.image-upload-wrapper');
  const placeholder = wrapper.querySelector('.upload-placeholder');
  const previewContainer = wrapper.querySelector('.preview-container');
  
  previewContainer.classList.add('d-none');
  placeholder.classList.remove('d-none');
  wrapper.style.borderStyle = 'dashed';
}

// Reset all previews on form reset
function resetPreviews() {
  setTimeout(() => { // minimal delay to let form reset happen first
    document.querySelectorAll('.image-upload-wrapper').forEach(wrapper => {
      const placeholder = wrapper.querySelector('.upload-placeholder');
      const previewContainer = wrapper.querySelector('.preview-container');
      
      if(placeholder && previewContainer) {
        previewContainer.classList.add('d-none');
        placeholder.classList.remove('d-none');
        wrapper.style.borderStyle = 'dashed';
      }
    });
  }, 10);
}
</script>

{% endblock %}