{% extends "user/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/bookingview.css' %}">

<div class="container py-5">
    <div class="row g-4">

        <!-- LEFT: Booking Form -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-4 p-md-5">

                    <h4 class="fw-bold mb-4">
                        Book <span class="text-primary">{{ vehicle.name }}</span>
                    </h4>

                    <form method="post"
                          action="{% url 'bookings:book-form' vehicle.id %}"
                          id="bookingForm"
                          novalidate>
                        {% csrf_token %}

                        <!-- Dates -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-muted">
                                    Pick-up Date
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white">
                                        <i class="bi bi-calendar-event"></i>
                                    </span>
                                    {{ form.start_date }}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-muted">
                                    Return Date
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white">
                                        <i class="bi bi-calendar-check"></i>
                                    </span>
                                    {{ form.end_date }}
                                </div>
                            </div>
                        </div>

                        <!-- Price Summary -->
                        <div class="bg-light rounded-4 p-4 mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">
                                    ₹{{ vehicle.price }} × <span id="daysCount">0</span> days
                                </span>
                                <span class="fw-semibold">
                                    ₹<span id="subtotal">0</span>
                                </span>
                            </div>

                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Insurance & Taxes</span>
                                <span class="text-success fw-semibold">Included</span>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold fs-5">Total</span>
                                <span class="fw-bold fs-4 text-primary">
                                    ₹<span id="totalAmount">0</span>
                                </span>
                            </div>
                        </div>

                        <!-- Submit -->
                        <button type="submit"
                                class="btn btn-primary w-100 py-3 fw-bold rounded-3"
                                {% if not vehicle.available %}disabled{% endif %}>
                            {% if vehicle.available %}
                                Confirm Booking
                            {% else %}
                                Currently Unavailable
                            {% endif %}
                        </button>

                        <p class="text-center text-muted mt-3 mb-0" style="font-size: 0.8rem;">
                            <i class="bi bi-shield-lock me-1"></i>
                            Secure booking & payment protected
                        </p>
                    </form>
                    

                </div>
            </div>
        </div>
        {% if form.errors %}
<div class="alert alert-danger">
    <strong>Form Errors:</strong>
    {{ form.errors }}
</div>
{% endif %}

        <!-- RIGHT: Vehicle Summary (Sticky) -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 position-sticky" style="top:120px;">
                <div class="card-body p-4">

                    <h6 class="fw-bold mb-3">Vehicle Summary</h6>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Vehicle</span>
                        <span class="fw-semibold">{{ vehicle.name }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Type</span>
                        <span>{{ vehicle.get_type_display }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Transmission</span>
                        <span>{{ vehicle.get_transmission_display }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Seats</span>
                        <span>{{ vehicle.seats }}</span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Price / Day</span>
                        <span class="fw-bold text-primary">₹{{ vehicle.price }}</span>
                    </div>

                    <a href="https://wa.me/918590995951?text=Hi%20I%20want%20to%20book%20{{ vehicle.name }}" target="_blank" class="btn btn-light w-100 mt-4 fw-bold">
                        <i class="bi bi-whatsapp text-success me-2"></i>
                        Chat with Agent
                    </a>
                </div>
            </div>
        </div>
        


    </div>
</div>

<!-- PRICE CALCULATION -->
<script>
document.addEventListener('DOMContentLoaded', function () {

    const startInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endInput = document.getElementById('{{ form.end_date.id_for_label }}');
    const dailyPrice = {{ vehicle.price }};

    function updatePrice() {
        if (startInput.value && endInput.value) {
            const s = new Date(startInput.value);
            const e = new Date(endInput.value);
            const days = Math.ceil((e - s) / (1000 * 60 * 60 * 24));

            if (days > 0) {
                const total = days * dailyPrice;
                document.getElementById('daysCount').innerText = days;
                document.getElementById('subtotal').innerText = total.toLocaleString('en-IN');
                document.getElementById('totalAmount').innerText = total.toLocaleString('en-IN');
            }
        }
    }

    startInput.addEventListener('change', () => {
        endInput.min = startInput.value;
        updatePrice();
    });
    endInput.addEventListener('change', updatePrice);
});
</script>

{% endblock %}
